# Plan 24-01: Data Layer Rewrite

## Goal
Convert all Supabase query builder calls to Drizzle ORM queries (~25 files, ~88 queries).

## Prerequisites
- Phase 23 complete (RLS policies updated)
- Drizzle schema created in Phase 21

## Tasks

### Task 1: Identify All Supabase Query Files
Files to update (from codebase analysis):

**Data Access Layers:**
- `src/lib/case-studies.ts` (6 queries)
- `src/lib/testimonials.ts` (8 queries)
- `src/lib/help-articles.ts` (4 queries)
- `src/lib/projects.ts` (6 queries)
- `src/lib/scheduled-emails.ts` (10 queries)

**API Routes:**
- `src/app/api/analytics/route.ts`
- `src/app/api/analytics/attribution/route.ts`
- `src/app/api/newsletter/route.ts`
- `src/app/api/newsletter/subscribe/route.ts`
- `src/app/api/calculators/submit/route.ts`
- `src/app/api/web-vitals/route.ts`
- `src/app/api/webhooks/n8n/route.ts`
- `src/app/api/webhooks/supabase/route.ts`
- `src/app/api/case-studies/route.ts`
- `src/app/api/admin/analytics/*.ts` (4 files)
- `src/app/api/admin/case-studies/route.ts`
- `src/app/api/admin/leads/[id]/*.ts` (2 files)
- `src/app/api/admin/errors/*.ts` (2 files)
- `src/app/api/cron/analytics-processing/route.ts`

**Server Actions:**
- `src/app/actions/ttl-calculator.ts` (8 queries)
- `src/app/actions/contact.ts` (indirect via services)

**Services:**
- `src/lib/logger.ts` (1 insert)
- `src/lib/services/contact-service.ts`

### Task 2: Create Query Migration Pattern
Before/After pattern for reference:

```typescript
// BEFORE (Supabase)
import { supabase } from '@/lib/supabase';

const { data, error } = await supabase
  .from('case_studies')
  .select('*')
  .eq('published', true)
  .order('created_at', { ascending: false });

if (error) throw error;
return data;

// AFTER (Drizzle)
import { db } from '@/lib/db';
import { caseStudies } from '@/lib/schema';
import { eq, desc } from 'drizzle-orm';

const data = await db
  .select()
  .from(caseStudies)
  .where(eq(caseStudies.published, true))
  .orderBy(desc(caseStudies.createdAt));

return data;
```

### Task 3: Migrate Data Access Layers
Start with the core data layers:

#### 3.1 Case Studies (`src/lib/case-studies.ts`)
```typescript
import { db } from '@/lib/db';
import { caseStudies } from '@/lib/schema';
import { eq, desc } from 'drizzle-orm';

export async function getCaseStudies() {
  return db
    .select()
    .from(caseStudies)
    .where(eq(caseStudies.published, true))
    .orderBy(desc(caseStudies.createdAt));
}

export async function getCaseStudyBySlug(slug: string) {
  const [study] = await db
    .select()
    .from(caseStudies)
    .where(eq(caseStudies.slug, slug))
    .where(eq(caseStudies.published, true))
    .limit(1);
  return study ?? null;
}

export async function getFeaturedCaseStudies() {
  return db
    .select()
    .from(caseStudies)
    .where(eq(caseStudies.published, true))
    .where(eq(caseStudies.featured, true))
    .orderBy(desc(caseStudies.createdAt));
}
```

#### 3.2 Continue with other data layers
Repeat pattern for:
- `testimonials.ts`
- `help-articles.ts`
- `projects.ts`
- `scheduled-emails.ts`

### Task 4: Migrate API Routes
Update each API route following the pattern. Example:

```typescript
// src/app/api/newsletter/subscribe/route.ts
import { db } from '@/lib/db';
import { newsletterSubscribers } from '@/lib/schema';
import { eq } from 'drizzle-orm';

export async function POST(request: Request) {
  const { email } = await request.json();

  // Check existing
  const [existing] = await db
    .select()
    .from(newsletterSubscribers)
    .where(eq(newsletterSubscribers.email, email))
    .limit(1);

  if (existing) {
    return Response.json({ error: 'Already subscribed' }, { status: 400 });
  }

  // Insert new
  const [subscriber] = await db
    .insert(newsletterSubscribers)
    .values({ email })
    .returning();

  return Response.json(subscriber);
}
```

### Task 5: Migrate Server Actions
Update `src/app/actions/ttl-calculator.ts` with Drizzle queries.

### Task 6: Update Logger
Update `src/lib/logger.ts` to use Drizzle for error logging:

```typescript
import { db } from '@/lib/db';
import { errorLogs } from '@/lib/schema';

async function logToDatabase(payload: ErrorLogPayload) {
  await db.insert(errorLogs).values(payload);
}
```

### Task 7: Run Tests After Each File
```bash
# After each file migration
bun run typecheck
bun test tests/
```

### Task 8: Final Verification
```bash
bun run lint
bun run typecheck
bun run build
bun test
```

## Success Criteria
- [ ] All 25+ files migrated from Supabase to Drizzle
- [ ] No `supabase.from()` calls remain in data layer
- [ ] TypeScript compiles without errors
- [ ] All unit tests pass
- [ ] Build succeeds

## Files Changed
- `src/lib/case-studies.ts`
- `src/lib/testimonials.ts`
- `src/lib/help-articles.ts`
- `src/lib/projects.ts`
- `src/lib/scheduled-emails.ts`
- `src/lib/logger.ts`
- `src/lib/services/contact-service.ts`
- `src/app/api/**/*.ts` (~15 files)
- `src/app/actions/ttl-calculator.ts`

## Migration Checklist
Use this to track progress:

- [ ] `src/lib/case-studies.ts`
- [ ] `src/lib/testimonials.ts`
- [ ] `src/lib/help-articles.ts`
- [ ] `src/lib/projects.ts`
- [ ] `src/lib/scheduled-emails.ts`
- [ ] `src/lib/logger.ts`
- [ ] `src/app/api/analytics/route.ts`
- [ ] `src/app/api/analytics/attribution/route.ts`
- [ ] `src/app/api/newsletter/route.ts`
- [ ] `src/app/api/newsletter/subscribe/route.ts`
- [ ] `src/app/api/calculators/submit/route.ts`
- [ ] `src/app/api/web-vitals/route.ts`
- [ ] `src/app/api/webhooks/n8n/route.ts`
- [ ] `src/app/api/webhooks/supabase/route.ts`
- [ ] `src/app/api/case-studies/route.ts`
- [ ] `src/app/api/admin/analytics/overview/route.ts`
- [ ] `src/app/api/admin/analytics/trends/route.ts`
- [ ] `src/app/api/admin/analytics/leads/route.ts`
- [ ] `src/app/api/admin/analytics/export/route.ts`
- [ ] `src/app/api/admin/case-studies/route.ts`
- [ ] `src/app/api/admin/leads/[id]/notes/route.ts`
- [ ] `src/app/api/admin/leads/[id]/update/route.ts`
- [ ] `src/app/api/admin/errors/route.ts`
- [ ] `src/app/api/admin/errors/[fingerprint]/route.ts`
- [ ] `src/app/api/cron/analytics-processing/route.ts`
- [ ] `src/app/actions/ttl-calculator.ts`

## Estimated Duration
4-8 hours (largest phase)
