# Plan 25-01: Auth Integration

## Goal
Replace `@supabase/ssr` with Neon Auth SDK, update middleware, auth wrapper, and admin auth.

## Prerequisites
- Phase 24 complete (data layer migrated)
- Research file: `.planning/phases/25-auth-integration/RESEARCH.md`

## Tasks

### Task 1: Install Neon Auth Dependencies
```bash
bun add @neondatabase/neon-js @supabase/postgrest-js
```

### Task 2: Initialize Neon Auth
Run the initialization wizard:
```bash
bunx @stackframe/init-stack@latest --no-browser
```

This creates:
- Auth handlers at `app/handler/[...stack]/page.tsx`
- `StackProvider` wrapper
- Server configuration in `stack.tsx`

### Task 3: Create Auth Client
Create `src/lib/auth/client.ts`:

```typescript
import { createAuthClient } from '@neondatabase/neon-js/auth';

export const authClient = createAuthClient(
  process.env.NEXT_PUBLIC_NEON_AUTH_URL!
);
```

### Task 4: Create Auth Server
Create `src/lib/auth/server.ts`:

```typescript
import { neonAuth } from '@neondatabase/neon-js/auth/server';

export async function getAuthUser() {
  const { session, user } = await neonAuth();

  if (!session || !user) {
    return null;
  }

  return {
    id: user.id,
    email: user.email,
  };
}

export async function requireAuth() {
  const user = await getAuthUser();
  if (!user) {
    throw new Error('Unauthorized');
  }
  return user;
}
```

### Task 5: Create Access Token Context
Create `src/context/access-token-context.tsx`:

```typescript
'use client';

import { createContext, useContext, useEffect, useState } from 'react';
import { useUser } from '@stackframe/stack';

const AccessTokenContext = createContext<string | null>(null);

export function AccessTokenProvider({ children }: { children: React.ReactNode }) {
  const user = useUser();
  const [accessToken, setAccessToken] = useState<string | null>(null);

  useEffect(() => {
    const fetchToken = async () => {
      if (user) {
        const auth = await user.getAuthJson();
        setAccessToken(auth.accessToken);
      }
    };

    fetchToken();
    const interval = setInterval(fetchToken, 60000); // Refresh every minute
    return () => clearInterval(interval);
  }, [user]);

  return (
    <AccessTokenContext.Provider value={accessToken}>
      {children}
    </AccessTokenContext.Provider>
  );
}

export function useAccessToken() {
  return useContext(AccessTokenContext);
}
```

### Task 6: Update Root Layout
Update `src/app/layout.tsx`:

```typescript
import { StackProvider, StackTheme } from '@stackframe/stack';
import { stackServerApp } from '@/stack';
import { AccessTokenProvider } from '@/context/access-token-context';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en" suppressHydrationWarning>
      <body>
        <StackProvider app={stackServerApp}>
          <StackTheme>
            <AccessTokenProvider>
              {children}
            </AccessTokenProvider>
          </StackTheme>
        </StackProvider>
      </body>
    </html>
  );
}
```

### Task 7: Update Middleware
Replace `src/middleware.ts` (or create `proxy.ts` for Next.js 16+):

```typescript
import { neonAuthMiddleware } from '@neondatabase/neon-js/auth/middleware';
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export async function middleware(request: NextRequest) {
  // Run Neon Auth middleware
  const authResponse = await neonAuthMiddleware(request, {
    loginUrl: '/auth/login',
  });

  if (authResponse) {
    return authResponse;
  }

  return NextResponse.next();
}

export const config = {
  matcher: [
    '/admin/:path*',
    '/account/:path*',
  ],
};
```

### Task 8: Update Admin Auth
Update `src/lib/admin-auth.ts`:

```typescript
import { getAuthUser } from '@/lib/auth/server';
import { NextResponse } from 'next/server';
import { logger } from '@/lib/logger';

// Lazy-loaded admin email whitelist
let _adminEmails: string[] | null = null;

function getAdminEmails(): string[] {
  if (_adminEmails === null) {
    if (!process.env.ADMIN_EMAILS?.trim()) {
      throw new Error('ADMIN_EMAILS environment variable is required');
    }
    _adminEmails = process.env.ADMIN_EMAILS.split(',')
      .map(e => e.trim().toLowerCase())
      .filter(e => e.length > 0);
  }
  return _adminEmails;
}

export async function validateAdminAuth() {
  try {
    const user = await getAuthUser();

    if (!user) {
      logger.warn('Admin API request without authentication');
      return {
        isAuthenticated: false,
        error: NextResponse.json({ error: 'Authentication required' }, { status: 401 }),
      };
    }

    const isAdmin = getAdminEmails().includes(user.email.toLowerCase());

    if (!isAdmin) {
      logger.warn('Admin API request from non-admin user', { email: user.email });
      return {
        isAuthenticated: false,
        error: NextResponse.json({ error: 'Insufficient permissions' }, { status: 403 }),
      };
    }

    return { isAuthenticated: true, user };
  } catch (error) {
    logger.error('Admin auth validation failed', { error });
    return {
      isAuthenticated: false,
      error: NextResponse.json({ error: 'Authentication failed' }, { status: 500 }),
    };
  }
}
```

### Task 9: Update Auth Wrapper Component
Update `src/components/admin/AuthWrapper.tsx`:

```typescript
'use client';

import { useUser, useStackApp } from '@stackframe/stack';
import { useRouter } from 'next/navigation';
import { useEffect, useState } from 'react';

interface AuthWrapperProps {
  children: React.ReactNode;
}

export function AuthWrapper({ children }: AuthWrapperProps) {
  const user = useUser();
  const app = useStackApp();
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    if (user === undefined) return; // Still loading

    if (!user) {
      router.push('/auth/login');
    } else {
      setIsLoading(false);
    }
  }, [user, router]);

  if (isLoading) {
    return <div>Loading...</div>;
  }

  return <>{children}</>;
}
```

### Task 10: Delete Supabase Auth Files
```bash
rm -f src/lib/supabase/server.ts
rm -f src/lib/supabase/client.ts
rm -f src/lib/supabase/middleware.ts
```

### Task 11: Test Auth Flow
1. Start dev server: `bun dev`
2. Navigate to `/auth/login`
3. Test login with existing user
4. Verify session persists
5. Test admin routes

## Success Criteria
- [ ] Neon Auth dependencies installed
- [ ] Auth client and server created
- [ ] Access token context working
- [ ] Root layout updated with providers
- [ ] Middleware protecting routes
- [ ] Admin auth using Neon Auth
- [ ] Auth wrapper component updated
- [ ] Supabase auth files deleted
- [ ] Login flow working
- [ ] Build succeeds

## Files Changed
- `package.json` (modified)
- `src/lib/auth/client.ts` (new)
- `src/lib/auth/server.ts` (new)
- `src/context/access-token-context.tsx` (new)
- `src/app/layout.tsx` (modified)
- `src/middleware.ts` or `proxy.ts` (modified/new)
- `src/lib/admin-auth.ts` (modified)
- `src/components/admin/AuthWrapper.tsx` (modified)
- `src/lib/supabase/server.ts` (deleted)
- `src/lib/supabase/client.ts` (deleted)
- `src/lib/supabase/middleware.ts` (deleted)
- `stack.tsx` (new - from init)
- `app/handler/[...stack]/page.tsx` (new - from init)

## Estimated Duration
2-3 hours
