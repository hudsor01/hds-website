---
phase: 38-api-route-cleanup
plan: 01
type: execute
---

<objective>
Delete orphaned API routes, remove fake admin-auth, clean up dead env vars and constants, wire up the paystub tool page, and consolidate newsletter endpoints.

Purpose: Eliminate speculative API routes that no frontend calls, remove the security theater of admin-auth.ts, and ensure every API route has a real consumer. Wire paystub calculator to an accessible page.
Output: Lean API surface with zero orphaned routes, no fake auth, paystub tool live at /paystub.
</objective>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/38-api-route-cleanup/38-01-PLAN.md

**User decisions:**
- Aggressive delete: remove ALL orphaned API routes including infrastructure (health, cron, CSP)
- Paystub: wire it up as a real tool page
- Testimonials: keep tool + routes, remove fake admin-auth.ts (auth was fake anyway)
- Delete admin routes that have no tool page consumers

**Source files to modify/delete:**
@src/lib/admin-auth.ts
@src/lib/constants/api-endpoints.ts
@src/env.ts
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete orphaned API routes and supporting files</name>
  <files>
    src/app/api/newsletter/route.ts
    src/app/api/csrf/route.ts
    src/app/api/health/route.ts
    src/app/api/pagespeed/route.ts
    src/app/api/lead-magnet/route.ts
    src/app/api/case-studies/route.ts
    src/app/api/analytics/attribution/route.ts
    src/app/api/analytics/route.ts
    src/app/api/csp-reports/route.ts
    src/app/api/generate-pdf/contract/route.ts
    src/app/api/generate-pdf/invoice/route.ts
    src/app/api/web-vitals/route.ts
    src/app/api/cron/analytics-processing/route.ts
    src/app/api/process-emails/route.ts
    src/app/api/paystub/route.ts
    src/lib/admin-auth.ts
  </files>
  <action>
  **Delete these orphaned API routes (zero frontend consumers):**

  1. `/api/newsletter/route.ts` -- duplicate of /subscribe, uses wrong table, no consumers
  2. `/api/csrf/route.ts` -- no frontend fetches CSRF tokens from this endpoint
  3. `/api/health/route.ts` -- no monitoring configured to call it
  4. `/api/pagespeed/route.ts` -- check if performance-calculator page uses it first; if yes, KEEP
  5. `/api/lead-magnet/route.ts` -- no frontend form calls it
  6. `/api/case-studies/route.ts` -- only in constants, no page/component calls it
  7. `/api/analytics/attribution/route.ts` -- no consumers
  8. `/api/analytics/route.ts` -- no consumers
  9. `/api/csp-reports/route.ts` -- only referenced server-side in security-headers, not a frontend consumer
  10. `/api/generate-pdf/contract/route.ts` -- tool pages use @react-pdf/renderer client-side, not this
  11. `/api/generate-pdf/invoice/route.ts` -- same as above
  12. `/api/web-vitals/route.ts` -- check if WebVitalsReporting component exists and uses it; if yes, KEEP
  13. `/api/cron/analytics-processing/route.ts` -- no cron configured
  14. `/api/process-emails/route.ts` -- no cron configured
  15. `/api/paystub/route.ts` -- no frontend calls it (paystub uses client-side calculation)

  **Delete admin-auth.ts:**
  - Remove `src/lib/admin-auth.ts` entirely
  - Remove all `import { requireAdminAuth }` and `const authError = await requireAdminAuth()` + if-blocks from:
    - `src/app/api/testimonials/route.ts`
    - `src/app/api/testimonials/[id]/route.ts`
    - `src/app/api/testimonials/requests/route.ts`
    - `src/app/api/testimonials/requests/[id]/route.ts`

  **IMPORTANT: Before deleting each route, verify it's truly orphaned:**
  - `/api/pagespeed/route.ts` -- grep for `pagespeed` in src/app/tools/performance-calculator/
  - `/api/web-vitals/route.ts` -- grep for `web-vitals` in src/components/
  - `/api/csp-reports/route.ts` -- grep for `csp-reports` in src/lib/security-headers.ts (if CSP header points to it, we may need to keep or update the header)

  After deletion, remove empty parent directories.
  </action>
  <verify>pnpm typecheck -- zero errors. No dangling imports referencing deleted files.</verify>
  <done>All orphaned API routes deleted. admin-auth.ts deleted. Testimonial routes have requireAdminAuth calls removed.</done>
</task>

<task type="auto">
  <name>Task 2: Clean up constants, env vars, and dead references</name>
  <files>
    src/lib/constants/api-endpoints.ts
    src/env.ts
    .env.example
  </files>
  <action>
  **1. src/lib/constants/api-endpoints.ts -- Remove orphaned endpoint constants:**

  Remove from API_ENDPOINTS:
  - TESTIMONIALS_SUBMIT (if no longer needed after cleanup -- check)
  - LEAD_MAGNET
  - PAYSTUB
  - CONTRACT
  - INVOICE
  - PROPOSAL
  - CASE_STUDIES
  - PORTFOLIO
  - BLOG_POSTS
  - RSS_FEED
  - ANALYTICS_PROCESSING

  Keep only endpoints that have real frontend consumers. Verify each before removing.

  Remove INTERNAL_API_ENDPOINTS entirely if SCHEDULED_EMAILS_PROCESS is also orphaned.

  **2. src/env.ts -- Remove dead env vars:**

  Remove from server section and runtimeEnv:
  - ADMIN_API_TOKEN (only consumer was /api/newsletter/route.ts, now deleted)
  - ADMIN_EMAILS (only consumer was admin-auth.ts, now deleted)
  - JWT_SECRET (zero consumers outside env.ts)
  - SLACK_WEBHOOK_URL (verify: any consumers? if not, remove)
  - CRON_SECRET (verify: any consumers? if cron routes deleted, remove)
  - KV_REST_API_URL / KV_REST_API_TOKEN (verify: used by rate limiter? if yes, keep)

  **3. .env.example -- Remove corresponding entries.**
  </action>
  <verify>pnpm typecheck && pnpm lint -- zero errors, zero warnings.</verify>
  <done>Constants file only contains endpoints with real consumers. env.ts only contains env vars something actually reads. .env.example matches.</done>
</task>

<task type="auto">
  <name>Task 3: Create paystub tool page</name>
  <files>
    src/app/(tools)/paystub/page.tsx
  </files>
  <action>
  Create a page.tsx that follows existing tool page patterns in the codebase.

  **Research first:**
  - Read an existing tool page (e.g., src/app/tools/tip-calculator/page.tsx or src/app/tools/invoice-generator/page.tsx) to understand the pattern
  - Check what hooks exist: use-paystub-form.ts, use-paystub-calculations.ts, use-paystub-calculator.ts, use-paystub-validation.ts
  - Check what components exist in src/components/ for paystub

  **Implementation:**
  - Server component page.tsx with metadata (title, description, OpenGraph)
  - Client component for the interactive form
  - Use existing hooks (use-paystub-form, use-paystub-calculations, etc.)
  - All calculation runs client-side (no API route needed)
  - Follow the (tools) route group pattern so URL is /paystub not /tools/paystub

  **Ensure:**
  - Proper metadata export
  - Semantic HTML and accessibility
  - Consistent with other tool pages in styling
  </action>
  <verify>pnpm typecheck && pnpm lint. Navigate to /paystub in dev server and verify it renders.</verify>
  <done>Paystub calculator accessible at /paystub with proper metadata, using existing hooks and calculation logic.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm lint` passes with zero warnings
- [ ] `pnpm typecheck` passes with zero errors
- [ ] `pnpm test:unit` passes (no regressions)
- [ ] No imports reference deleted files
- [ ] Every API route in src/app/api/ has at least one frontend consumer (except /api/testimonials/* which are used by testimonial-collector tool)
- [ ] /paystub page renders and uses existing calculator hooks
- [ ] env.ts has no env vars with zero consumers
- [ ] api-endpoints.ts has no constants pointing to deleted routes
</verification>

<success_criteria>
- All orphaned API routes deleted
- admin-auth.ts deleted, fake auth removed from testimonial routes
- Dead env vars (ADMIN_API_TOKEN, ADMIN_EMAILS, JWT_SECRET) removed
- Dead constants removed from api-endpoints.ts
- Paystub tool live at /paystub
- Zero lint/type errors, all tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/38-api-route-cleanup/38-01-SUMMARY.md`
</output>
