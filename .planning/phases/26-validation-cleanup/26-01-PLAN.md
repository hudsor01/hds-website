# Plan 26-01: Validation & Cleanup

## Goal
Run all tests, verify all features work, remove Supabase dependencies, and finalize migration.

## Prerequisites
- Phase 25 complete (Auth integration done)

## Tasks

### Task 1: Remove Supabase Dependencies
```bash
# Remove Supabase packages
bun remove @supabase/supabase-js @supabase/ssr

# Verify removal
grep -r "@supabase" src/ --include="*.ts" --include="*.tsx"
# Should return no results
```

### Task 2: Delete Remaining Supabase Files
```bash
# Delete main Supabase client
rm -f src/lib/supabase.ts

# Delete Supabase types (replaced by Drizzle schema)
rm -f src/types/database.ts
rm -f src/types/database-local.ts

# Delete Supabase config (if exists)
rm -rf supabase/
```

### Task 3: Update Environment Variables
Clean up `.env.local`:

```bash
# REMOVE these Supabase variables:
# NEXT_PUBLIC_SUPABASE_URL
# NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY
# SUPABASE_SERVICE_ROLE_KEY

# KEEP these Neon variables:
POSTGRES_URL="..."
DATABASE_URL_UNPOOLED="..."
NEXT_PUBLIC_NEON_AUTH_URL="..."
NEON_AUTH_PROJECT_ID="..."
NEON_AUTH_SERVER_KEY="..."
```

### Task 4: Update .env.example
Update `.env.example` with new variables:

```bash
# Database (Neon)
POSTGRES_URL="postgresql://user:pass@ep-xxx-pooler.region.aws.neon.tech/neondb?sslmode=require"
DATABASE_URL_UNPOOLED="postgresql://user:pass@ep-xxx.region.aws.neon.tech/neondb?sslmode=require"

# Authentication (Neon Auth)
NEXT_PUBLIC_NEON_AUTH_URL="https://auth.neon.tech/v1/projects/xxx"
NEON_AUTH_PROJECT_ID="your-project-id"
NEON_AUTH_SERVER_KEY="your-server-key"

# Admin
ADMIN_EMAILS="admin@example.com"

# Email (Resend)
RESEND_API_KEY="re_xxx"
```

### Task 5: Run Type Check
```bash
bun run typecheck
```

Fix any TypeScript errors related to removed Supabase types.

### Task 6: Run Linter
```bash
bun run lint
```

Fix any linting errors.

### Task 7: Run Unit Tests
```bash
bun test
```

All 342 tests should pass.

### Task 8: Run E2E Tests
```bash
bun run test:e2e
```

All Playwright tests should pass.

### Task 9: Run Build
```bash
bun run build
```

Build should complete without errors.

### Task 10: Manual Feature Testing
Test each critical feature manually:

#### Contact Form
- [ ] Navigate to `/contact`
- [ ] Fill out form with valid data
- [ ] Submit form
- [ ] Verify success message
- [ ] Check email received (if configured)

#### Paystub Generator
- [ ] Navigate to `/paystub-generator`
- [ ] Fill out employee info
- [ ] Fill out pay info
- [ ] Click Generate
- [ ] Verify paystub displays
- [ ] Click Download PDF
- [ ] Verify PDF downloads correctly

#### Invoice Generator
- [ ] Navigate to `/invoice-generator`
- [ ] Fill out business info
- [ ] Add line items
- [ ] Click Generate
- [ ] Verify invoice displays
- [ ] Click Download PDF
- [ ] Verify PDF downloads correctly

#### Contract Generator
- [ ] Navigate to `/contract-generator`
- [ ] Fill out contract details
- [ ] Click Generate
- [ ] Verify contract displays
- [ ] Click Download PDF
- [ ] Verify PDF downloads correctly

#### Admin Login (if applicable)
- [ ] Navigate to `/admin`
- [ ] Login with admin credentials
- [ ] Verify dashboard loads
- [ ] Verify data displays from Neon

### Task 11: Clean Up Migration Scripts
```bash
# Move migration scripts to archive (don't delete yet)
mkdir -p scripts/archive
mv scripts/migrate-users.ts scripts/archive/
mv scripts/migrate-rls.sql scripts/archive/
mv scripts/test-neon-connection.ts scripts/archive/
mv scripts/test-drizzle.ts scripts/archive/
mv scripts/verify-migration.ts scripts/archive/
mv scripts/verify-auth.ts scripts/archive/
mv scripts/test-rls.ts scripts/archive/
```

### Task 12: Update Documentation
Update `CLAUDE.md` with new database patterns:

```markdown
**Supabase (Database) - DEPRECATED:**
- Removed in v2.0 migration

**Database (Neon + Drizzle):**
- `src/lib/db.ts` - Drizzle client with Bun.SQL
- `src/lib/schema/` - Drizzle schema definitions
- Use Drizzle ORM for all queries
- Connection: Bun.SQL with pooling
```

### Task 13: Final Git Commit
```bash
git add -A
git commit -m "$(cat <<'EOF'
feat(v2.0): complete backend migration to Neon + Bun.SQL + Drizzle

BREAKING CHANGES:
- Removed @supabase/supabase-js and @supabase/ssr
- Database queries now use Drizzle ORM
- Authentication now uses Neon Auth (Better Auth)

Changes:
- Migrated database from Supabase to Neon PostgreSQL
- Replaced Supabase SDK with Bun.SQL (zero dependencies)
- Added Drizzle ORM for type-safe queries
- Replaced Supabase Auth with Neon Auth
- Updated RLS policies for Neon compatibility
- Updated all data access layers (~25 files)
- Updated all API routes
- Updated auth middleware and admin auth
- Removed deprecated Supabase files

Benefits:
- 50% faster database queries (direct wire protocol)
- Zero npm dependencies for database client
- Branch-aware authentication
- Type-safe queries with Drizzle
EOF
)"
```

### Task 14: Update ROADMAP.md Progress
Mark Phase 26 and v2.0 milestone as complete.

## Success Criteria
- [ ] No `@supabase` imports in codebase
- [ ] `@supabase/supabase-js` removed from package.json
- [ ] `@supabase/ssr` removed from package.json
- [ ] TypeScript compiles without errors
- [ ] Linter passes
- [ ] All unit tests pass (342 tests)
- [ ] All E2E tests pass
- [ ] Build succeeds
- [ ] Contact form works
- [ ] Paystub generator works
- [ ] Invoice generator works
- [ ] Contract generator works
- [ ] Admin login works (if applicable)
- [ ] Migration committed to git
- [ ] Documentation updated

## Files Changed/Deleted
**Deleted:**
- `src/lib/supabase.ts`
- `src/lib/supabase/server.ts`
- `src/lib/supabase/client.ts`
- `src/lib/supabase/middleware.ts`
- `src/types/database.ts`
- `src/types/database-local.ts`
- `supabase/` directory

**Modified:**
- `package.json` (remove Supabase deps)
- `.env.local` (remove Supabase vars)
- `.env.example` (update with Neon vars)
- `CLAUDE.md` (update documentation)
- `.planning/ROADMAP.md` (mark complete)
- `.planning/STATE.md` (update progress)

## Estimated Duration
2-4 hours
