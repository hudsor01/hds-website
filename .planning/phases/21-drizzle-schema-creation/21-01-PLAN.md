# Plan 21-01: Drizzle Schema Creation

## Goal
Convert Supabase types to Drizzle schema, configure drizzle-kit, and set up the database client.

## Prerequisites
- Phase 20 complete (data in Neon)
- Research file: `.planning/phases/21-drizzle-schema-creation/RESEARCH.md`

## Tasks

### Task 1: Install Dependencies
```bash
bun add drizzle-orm
bun add -D drizzle-kit
```

### Task 2: Create Drizzle Config
Create `drizzle.config.ts` at project root:

```typescript
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'postgresql',
  schema: './src/lib/schema',
  out: './drizzle',
  dbCredentials: {
    url: process.env.DATABASE_URL_UNPOOLED!,
  },
  introspect: {
    casing: 'camel',
  },
});
```

### Task 3: Introspect Existing Database
```bash
# Pull schema from Neon database
bunx drizzle-kit pull
```

This generates schema files in `./drizzle/` based on existing tables.

### Task 4: Organize Schema Files
Move and organize generated schemas into `src/lib/schema/`:

```
src/lib/schema/
├── index.ts              # Re-exports all schemas
├── common.ts             # Shared patterns (timestamps)
├── leads.ts              # calculator_leads, lead_notes, lead_attribution
├── content.ts            # case_studies, testimonials, help_articles
├── analytics.ts          # web_vitals, custom_events, page_analytics
├── emails.ts             # scheduled_emails, newsletter_subscribers
├── projects.ts           # projects
├── system.ts             # error_logs, cron_logs, webhook_logs
└── ttl.ts                # ttl_calculations
```

### Task 5: Create Database Client
Create `src/lib/db.ts`:

```typescript
import { drizzle } from 'drizzle-orm/bun-sql';
import { SQL } from 'bun';
import * as schema from './schema';

// Create Bun.SQL client with connection pooling
const client = new SQL({
  url: process.env.POSTGRES_URL,
  max: 20,
  idleTimeout: 30,
  connectionTimeout: 10,
  tls: true,
});

// Create Drizzle instance with schema
export const db = drizzle({ client, schema });

// Export for direct SQL queries if needed
export { client as sql };
```

### Task 6: Create Schema Index
Create `src/lib/schema/index.ts`:

```typescript
// Re-export all schemas
export * from './leads';
export * from './content';
export * from './analytics';
export * from './emails';
export * from './projects';
export * from './system';
export * from './ttl';
```

### Task 7: Test Schema
Create test script:

```typescript
// scripts/test-drizzle.ts
import { db } from '../src/lib/db';
import { caseStudies } from '../src/lib/schema';

async function test() {
  // Test select
  const studies = await db.select().from(caseStudies).limit(5);
  console.log('Case studies:', studies.length);

  // Test type inference
  type CaseStudy = typeof caseStudies.$inferSelect;
  console.log('Type inference working!');
}

test().catch(console.error);
```

### Task 8: Verify Build
```bash
bun run build
bun run typecheck
```

## Success Criteria
- [ ] drizzle-orm and drizzle-kit installed
- [ ] drizzle.config.ts created
- [ ] Schema introspected from database
- [ ] Schema files organized in src/lib/schema/
- [ ] Database client created in src/lib/db.ts
- [ ] Test script runs successfully
- [ ] Build and typecheck pass

## Files Changed
- `package.json` (modified - add drizzle deps)
- `drizzle.config.ts` (new)
- `src/lib/db.ts` (new)
- `src/lib/schema/index.ts` (new)
- `src/lib/schema/*.ts` (new - multiple files)
- `scripts/test-drizzle.ts` (new)

## Estimated Duration
1-2 hours
