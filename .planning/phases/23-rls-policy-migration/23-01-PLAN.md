# Plan 23-01: RLS Policy Migration

## Goal
Update all Row-Level Security policies for Neon Auth compatibility.

## Prerequisites
- Phase 22 complete (Auth migration done)

## Tasks

### Task 1: Identify Existing RLS Policies
```sql
-- Run in Neon SQL Editor
SELECT
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd,
  qual,
  with_check
FROM pg_policies
WHERE schemaname = 'public'
ORDER BY tablename, policyname;
```

Document all existing policies.

### Task 2: Update Auth Function References
Replace all `auth.uid()` with `auth.user_id()`:

```sql
-- Example: Update policy on calculator_leads
DROP POLICY IF EXISTS "Users can view own leads" ON calculator_leads;
CREATE POLICY "Users can view own leads" ON calculator_leads
  FOR SELECT USING (auth.user_id() = user_id);

DROP POLICY IF EXISTS "Users can insert own leads" ON calculator_leads;
CREATE POLICY "Users can insert own leads" ON calculator_leads
  FOR INSERT WITH CHECK (auth.user_id() = user_id);
```

### Task 3: Update Role Names
Replace `anon` with `anonymous`:

```sql
-- Grant permissions to anonymous role
GRANT SELECT ON calculator_leads TO anonymous;
GRANT SELECT ON case_studies TO anonymous;
GRANT SELECT ON testimonials TO anonymous;
GRANT SELECT ON help_articles TO anonymous;

-- Grant full permissions to authenticated role
GRANT SELECT, INSERT, UPDATE, DELETE ON calculator_leads TO authenticated;
GRANT SELECT, INSERT, UPDATE, DELETE ON lead_notes TO authenticated;
```

### Task 4: Create Migration Script
Create `scripts/migrate-rls.sql`:

```sql
-- RLS Policy Migration: Supabase to Neon Auth
-- Run this in Neon SQL Editor

BEGIN;

-- ============================================
-- 1. Update role grants
-- ============================================

-- Public read access (anonymous)
GRANT USAGE ON SCHEMA public TO anonymous;
GRANT SELECT ON case_studies TO anonymous;
GRANT SELECT ON testimonials TO anonymous;
GRANT SELECT ON help_articles TO anonymous;

-- Authenticated user access
GRANT USAGE ON SCHEMA public TO authenticated;
GRANT ALL ON ALL TABLES IN SCHEMA public TO authenticated;

-- Default privileges for future tables
ALTER DEFAULT PRIVILEGES IN SCHEMA public
  GRANT SELECT ON TABLES TO anonymous;
ALTER DEFAULT PRIVILEGES IN SCHEMA public
  GRANT ALL ON TABLES TO authenticated;

-- ============================================
-- 2. Update RLS policies
-- ============================================

-- calculator_leads
DROP POLICY IF EXISTS "Users can view own leads" ON calculator_leads;
CREATE POLICY "Users can view own leads" ON calculator_leads
  FOR SELECT USING (auth.user_id() = user_id OR user_id IS NULL);

DROP POLICY IF EXISTS "Anyone can insert leads" ON calculator_leads;
CREATE POLICY "Anyone can insert leads" ON calculator_leads
  FOR INSERT WITH CHECK (true);

-- lead_notes (authenticated only)
DROP POLICY IF EXISTS "Users can manage own notes" ON lead_notes;
CREATE POLICY "Users can manage own notes" ON lead_notes
  FOR ALL USING (auth.user_id() IS NOT NULL);

-- scheduled_emails
DROP POLICY IF EXISTS "Admins can manage emails" ON scheduled_emails;
CREATE POLICY "Admins can manage emails" ON scheduled_emails
  FOR ALL USING (auth.user_id() IS NOT NULL);

-- ttl_calculations
DROP POLICY IF EXISTS "Users can view own calculations" ON ttl_calculations;
CREATE POLICY "Users can view own calculations" ON ttl_calculations
  FOR SELECT USING (user_id IS NULL OR auth.user_id() = user_id);

DROP POLICY IF EXISTS "Anyone can create calculations" ON ttl_calculations;
CREATE POLICY "Anyone can create calculations" ON ttl_calculations
  FOR INSERT WITH CHECK (true);

COMMIT;

-- ============================================
-- 3. Verify policies
-- ============================================
SELECT tablename, policyname, cmd, qual
FROM pg_policies
WHERE schemaname = 'public'
ORDER BY tablename;
```

### Task 5: Run Migration
```bash
# Run the SQL script in Neon
psql "$DATABASE_URL_UNPOOLED" -f scripts/migrate-rls.sql
```

### Task 6: Test RLS Policies
Create test script:

```typescript
// scripts/test-rls.ts
import { SQL } from 'bun';

// Test as anonymous (no auth)
const anonSql = new SQL(process.env.POSTGRES_URL);

// Test as authenticated (with JWT - you'd need to set this up)
// const authSql = new SQL({ ...config, role: 'authenticated' });

async function testAnonymous() {
  console.log('Testing anonymous access...\n');

  // Should work: public tables
  const studies = await anonSql`SELECT COUNT(*) FROM case_studies`;
  console.log('case_studies (public):', studies[0].count, 'rows - OK');

  const testimonials = await anonSql`SELECT COUNT(*) FROM testimonials`;
  console.log('testimonials (public):', testimonials[0].count, 'rows - OK');

  // Should work: insert leads
  // (Don't actually insert in test, just verify policy exists)
  console.log('\nAnonymous access tests passed!');
}

testAnonymous()
  .catch(console.error)
  .finally(() => anonSql.close());
```

## Success Criteria
- [ ] All existing RLS policies identified
- [ ] `auth.uid()` replaced with `auth.user_id()` in all policies
- [ ] `anon` role replaced with `anonymous`
- [ ] Migration script created and run
- [ ] RLS tests pass for anonymous access
- [ ] RLS tests pass for authenticated access

## Files Changed
- `scripts/migrate-rls.sql` (new)
- `scripts/test-rls.ts` (new)

## Notes
- Run migration script during low-traffic period
- Keep backup of original policies
- Test both anonymous and authenticated access

## Estimated Duration
1-2 hours
