# Plan 20-01: Database Migration

## Goal
Export all data from Supabase PostgreSQL and import to Neon using pg_dump/pg_restore.

## Prerequisites
- Phase 19 complete (Neon project created)
- `pg_dump` and `pg_restore` installed (comes with PostgreSQL)
- Supabase direct connection string (not pooled)

## Tasks

### Task 1: Get Supabase Connection String
From Supabase Dashboard > Project Settings > Database:
1. Copy the **Direct connection string** (not pooled)
2. Format: `postgresql://postgres.[project-ref]:[password]@aws-0-[region].pooler.supabase.com:5432/postgres`

### Task 2: Export from Supabase
```bash
# Export public schema with custom format
pg_dump -Fc -v \
  -d "postgresql://postgres.[project-ref]:[password]@db.[project-ref].supabase.co:5432/postgres" \
  --schema=public \
  --no-owner \
  --no-acl \
  -f supabase_dump.bak

# Verify dump file created
ls -lh supabase_dump.bak
```

Flags explained:
- `-Fc`: Custom format (compressed, supports pg_restore)
- `-v`: Verbose output
- `--schema=public`: Only public schema (skip auth, storage, etc.)
- `--no-owner`: Skip ownership (Supabase-specific roles)
- `--no-acl`: Skip access privileges

### Task 3: Import to Neon
```bash
# Restore to Neon
pg_restore -v \
  -d "$DATABASE_URL_UNPOOLED" \
  --no-owner \
  --no-acl \
  supabase_dump.bak
```

### Task 4: Verify Row Counts
Create verification script:

```typescript
// scripts/verify-migration.ts
import { SQL } from 'bun';

const sql = new SQL(process.env.POSTGRES_URL);

const tables = [
  'calculator_leads',
  'case_studies',
  'testimonials',
  'help_articles',
  'projects',
  'scheduled_emails',
  'newsletter_subscribers',
  'lead_attribution',
  'error_logs',
  'web_vitals',
  'custom_events',
];

async function verify() {
  console.log('Table Row Counts in Neon:\n');

  for (const table of tables) {
    try {
      const [result] = await sql`SELECT COUNT(*) as count FROM ${sql(table)}`;
      console.log(`${table}: ${result.count} rows`);
    } catch (e) {
      console.log(`${table}: ERROR - ${e.message}`);
    }
  }

  await sql.close();
}

verify().catch(console.error);
```

Run: `bun run scripts/verify-migration.ts`

Compare with Supabase counts (run same query there).

### Task 5: Backup Dump File
```bash
# Keep backup in a safe location (not in git)
mv supabase_dump.bak ~/backups/business-website-$(date +%Y%m%d).bak
```

## Success Criteria
- [ ] pg_dump completes without errors
- [ ] pg_restore completes without errors
- [ ] All table row counts match between Supabase and Neon
- [ ] No data loss verified
- [ ] Backup stored safely

## Files Changed
- `scripts/verify-migration.ts` (new)
- `supabase_dump.bak` (temporary, not committed)

## Notes
- Do NOT include `supabase_dump.bak` in git (contains sensitive data)
- Keep Supabase running until Phase 26 validation complete
- If restore fails, check PostgreSQL version compatibility

## Estimated Duration
30-60 minutes (depends on data size)
