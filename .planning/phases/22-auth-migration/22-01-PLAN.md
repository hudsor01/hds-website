# Plan 22-01: Auth Migration

## Goal
Export Supabase users, enable Neon Auth, import users with preserved password hashes.

## Prerequisites
- Phase 21 complete (Drizzle schema ready)
- Research file: `.planning/phases/22-auth-migration/RESEARCH.md`

## Tasks

### Task 1: Export Users from Supabase
Run in Supabase SQL Editor:

```sql
-- Create export function
CREATE OR REPLACE FUNCTION ufn_get_user_emails_and_passwords()
RETURNS TABLE (email text, encrypted_password character varying(255)) AS
$$
BEGIN
  RETURN QUERY
  SELECT DISTINCT ON (i.email)
    i.email,
    u.encrypted_password
  FROM auth.users u
  JOIN auth.identities i ON u.id = i.user_id;
END;
$$ LANGUAGE plpgsql;

-- Run export
SELECT * FROM ufn_get_user_emails_and_passwords();
```

Export results as `user_data.csv`.

### Task 2: Enable Neon Auth
1. Go to Neon Console > your project
2. Navigate to **Data API** section
3. Click **Enable Neon Auth**
4. Configure authentication provider
5. Copy environment variables:
   - `NEON_AUTH_PROJECT_ID`
   - `NEON_AUTH_SERVER_KEY`
   - `NEXT_PUBLIC_NEON_AUTH_URL`

### Task 3: Update Environment Variables
Add to `.env.local`:

```bash
# Neon Auth
NEXT_PUBLIC_NEON_AUTH_URL="https://auth.neon.tech/v1/projects/xxx"
NEON_AUTH_PROJECT_ID="xxx"
NEON_AUTH_SERVER_KEY="xxx"
```

### Task 4: Create User Import Script
Create `scripts/migrate-users.ts`:

```typescript
import fs from 'fs';
import { parse } from 'csv-parse/sync';

const CONFIG = {
  csvFilePath: './user_data.csv',
  apiUrl: 'https://api.stack-auth.com/api/v1/users',
  headers: {
    'Content-Type': 'application/json',
    'X-Stack-Project-Id': process.env.NEON_AUTH_PROJECT_ID!,
    'X-Stack-Secret-Server-Key': process.env.NEON_AUTH_SERVER_KEY!,
    'X-Stack-Access-Type': 'server',
  },
  requestDelay: 500, // ms between requests
};

interface UserRecord {
  email: string;
  encrypted_password?: string;
}

async function migrateUsers() {
  const fileContent = fs.readFileSync(CONFIG.csvFilePath, 'utf8');
  const records: UserRecord[] = parse(fileContent, {
    columns: true,
    skip_empty_lines: true,
    trim: true,
  });

  console.log(`Found ${records.length} users to migrate.\n`);

  let success = 0;
  let failed = 0;

  for (const [index, user] of records.entries()) {
    const { email, encrypted_password } = user;

    if (!email) {
      console.error(`Row ${index + 1}: Missing email`);
      failed++;
      continue;
    }

    const payload: Record<string, unknown> = {
      primary_email: email,
      primary_email_verified: true,
      primary_email_auth_enabled: true,
    };

    if (encrypted_password && encrypted_password !== 'null') {
      payload.password_hash = encrypted_password;
    }

    console.log(`[${index + 1}/${records.length}] Creating: ${email}...`);

    try {
      const response = await fetch(CONFIG.apiUrl, {
        method: 'POST',
        headers: CONFIG.headers,
        body: JSON.stringify(payload),
      });

      if (!response.ok) {
        const data = await response.json();
        console.error(`Failed: ${JSON.stringify(data)}`);
        failed++;
      } else {
        success++;
      }
    } catch (error) {
      console.error(`Error: ${error}`);
      failed++;
    }

    await new Promise(r => setTimeout(r, CONFIG.requestDelay));
  }

  console.log('\n===== Migration Summary =====');
  console.log(`Total: ${records.length}`);
  console.log(`Success: ${success}`);
  console.log(`Failed: ${failed}`);
}

migrateUsers();
```

Install csv-parse:
```bash
bun add csv-parse
```

### Task 5: Run User Migration
```bash
bun run scripts/migrate-users.ts
```

### Task 6: Create User ID Mapping
After users are imported, create mapping table:

```sql
-- In Neon SQL Editor
-- Create temp table with old Supabase user data
CREATE TABLE IF NOT EXISTS temp_user_mapping (
  old_id UUID,
  email TEXT PRIMARY KEY
);

-- You'll need to populate this from Supabase export
-- INSERT INTO temp_user_mapping (old_id, email) VALUES ...
```

### Task 7: Remap User IDs in Tables
For each table with user_id foreign key:

```sql
-- Example for calculator_leads
UPDATE calculator_leads AS cl
SET user_id = ns.id::text
FROM temp_user_mapping AS tm
JOIN neon_auth.users_sync AS ns ON tm.email = ns.email
WHERE cl.user_id = tm.old_id::text;

-- Change column type from UUID to TEXT
ALTER TABLE calculator_leads ALTER COLUMN user_id TYPE text;
```

Repeat for all tables with user_id.

### Task 8: Verify Auth Migration
```typescript
// scripts/verify-auth.ts
import { SQL } from 'bun';

const sql = new SQL(process.env.POSTGRES_URL);

async function verify() {
  // Count users in Neon Auth
  const [authCount] = await sql`
    SELECT COUNT(*) as count FROM neon_auth.users_sync
  `;
  console.log('Users in Neon Auth:', authCount.count);

  // Verify a user can be looked up
  const [user] = await sql`
    SELECT id, email FROM neon_auth.users_sync LIMIT 1
  `;
  console.log('Sample user:', user);

  await sql.close();
}

verify().catch(console.error);
```

## Success Criteria
- [ ] Users exported from Supabase
- [ ] Neon Auth enabled in console
- [ ] Environment variables configured
- [ ] Users imported with password hashes preserved
- [ ] User ID mapping created
- [ ] Foreign keys remapped to new user IDs
- [ ] Verification script passes

## Files Changed
- `.env.local` (modified - add Neon Auth vars)
- `scripts/migrate-users.ts` (new)
- `scripts/verify-auth.ts` (new)
- `user_data.csv` (temporary, not committed)

## Security Notes
- NEVER commit `user_data.csv` (contains password hashes)
- Delete CSV after migration verified
- Test login with a few users before proceeding

## Estimated Duration
1-2 hours
