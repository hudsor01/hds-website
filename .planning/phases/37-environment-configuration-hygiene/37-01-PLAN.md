---
phase: 37-environment-configuration-hygiene
plan: 01
type: execute
---

<objective>
Add all bypassed env vars to env.ts validation, update .env.example from Supabase to Neon/Drizzle references, and fix CSP reports empty string bug.

Purpose: Eliminate configuration drift where env vars bypass the validation layer, ensuring misconfigurations fail fast at startup instead of silently at runtime. Clean up stale Supabase-era references.
Output: All env vars flow through env.ts, .env.example reflects current stack, CSP reports route cleaned up.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-environment-configuration-hygiene/37-CONTEXT.md

# Source files being modified:
@src/env.ts
@src/lib/db.ts
@src/lib/pdf/stirling-client.ts
@src/app/api/auth/[...path]/route.ts
@src/app/api/lead-magnet/route.ts
@src/app/api/csp-reports/route.ts
@.env.example

**Constraining decisions:**
- Migrated from Supabase to Drizzle ORM + Neon (Phase 20-26)
- @t3-oss/env-nextjs already configured in src/env.ts
- Auth is partial/undecided (Phase 39 will decide strategy)
- Solo repo -- .env.example accuracy is low priority but should reflect current stack

**Exclusions:**
- DATABASE_URL_UNPOOLED stays as process.env in drizzle.config.ts (drizzle-kit runs outside Next.js, env.ts doesn't apply)
- logger.ts stays as process.env.NODE_ENV (Next.js inlines this at build time for dead-code elimination -- intentional pattern)
- SKIP_ENV_VALIDATION stays as process.env (it's the meta-config that controls env.ts itself)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bypassed env vars to env.ts and update all consumers</name>
  <files>src/env.ts, src/lib/db.ts, src/lib/pdf/stirling-client.ts, src/app/api/auth/[...path]/route.ts, src/app/api/lead-magnet/route.ts</files>
  <action>
  **1. src/env.ts -- Add 4 new server env vars:**

  Add to `server` section (all optional since they're feature-specific or CI-skippable):
  - POSTGRES_URL: z.string().url().optional() -- Database connection (optional for CI builds)
  - NEON_AUTH_BASE_URL: z.string().url().optional() -- Auth (partial feature, Phase 39 decides)
  - NEON_AUTH_COOKIE_SECRET: z.string().min(1).optional() -- Auth cookie secret
  - STIRLING_PDF_URL: z.string().url().optional() -- PDF generation service

  Add corresponding entries to `runtimeEnv` section:
  - POSTGRES_URL: process.env.POSTGRES_URL
  - NEON_AUTH_BASE_URL: process.env.NEON_AUTH_BASE_URL
  - NEON_AUTH_COOKIE_SECRET: process.env.NEON_AUTH_COOKIE_SECRET
  - STIRLING_PDF_URL: process.env.STIRLING_PDF_URL

  Group the database vars near the top of server section (after NODE_ENV), auth vars together, and STIRLING with the other service integrations.

  **2. src/lib/db.ts -- Use env.ts for POSTGRES_URL:**

  Add `import { env } from '@/env';` at the top.
  Change line 11: `const isCIBuild = process.env.SKIP_ENV_VALIDATION === 'true' && !env.POSTGRES_URL;`
  (Keep SKIP_ENV_VALIDATION as process.env -- it's the meta-config for env.ts itself)
  Change line 18: `const url = env.POSTGRES_URL;`

  **3. src/lib/pdf/stirling-client.ts -- Use env.ts for STIRLING_PDF_URL:**

  Add `import { env } from '@/env';`
  Change line 14: `const url = env.STIRLING_PDF_URL;`

  **4. src/app/api/auth/[...path]/route.ts -- Use env.ts for NEON_AUTH vars:**

  Add `import { env } from '@/env';`
  Change line 8: `baseUrl: env.NEON_AUTH_BASE_URL!,`
  Change line 10: `secret: env.NEON_AUTH_COOKIE_SECRET!,`
  (Keep the ! assertions -- these vars are required when the auth route is actually used, but optional in env.ts since auth is a partial feature)

  **5. src/app/api/lead-magnet/route.ts -- Use env.ts for DISCORD_WEBHOOK_URL:**

  Add `import { env } from '@/env';` (DISCORD_WEBHOOK_URL is already in env.ts)
  Change the two references to process.env.DISCORD_WEBHOOK_URL to env.DISCORD_WEBHOOK_URL
  </action>
  <verify>pnpm typecheck && pnpm lint -- zero errors, zero warnings. Grep for "process.env" in src/ excluding env.ts, logger.ts, and test files -- only SKIP_ENV_VALIDATION, NODE_ENV (in logger), and drizzle.config.ts should remain.</verify>
  <done>All 4 bypassed env vars (POSTGRES_URL, NEON_AUTH_BASE_URL, NEON_AUTH_COOKIE_SECRET, STIRLING_PDF_URL) defined in env.ts with Zod schemas. All 5 consumer files import from env.ts instead of process.env. Zero TypeScript errors, zero lint warnings.</done>
</task>

<task type="auto">
  <name>Task 2: Update .env.example and fix CSP empty string bug</name>
  <files>.env.example, src/app/api/csp-reports/route.ts</files>
  <action>
  **1. .env.example -- Replace Supabase references with Neon/Drizzle:**

  Remove these stale Supabase entries:
  - NEXT_PUBLIC_SUPABASE_URL
  - NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY
  - SUPABASE_SERVICE_ROLE_KEY
  - SUPABASE_WEBHOOK_SECRET
  - All associated comments referencing Supabase

  Add these current entries in a "Database - Neon/Drizzle" section:
  - POSTGRES_URL=postgresql://user:password@host/dbname (pooled connection for app runtime)
  - DATABASE_URL_UNPOOLED=postgresql://user:password@host/dbname (direct connection for Drizzle migrations)

  Add in an "Auth - Neon Auth" section (mark as optional/partial):
  - NEON_AUTH_BASE_URL=https://your-project.api.neon.tech (Neon Auth API base URL)
  - NEON_AUTH_COOKIE_SECRET=generate_a_random_secret_here (Auth cookie encryption)

  Add in a "PDF Generation" section:
  - STIRLING_PDF_URL=http://localhost:8080 (Stirling PDF service URL)

  Keep the overall structure and formatting consistent with existing sections. Update the header comment if it mentions Supabase.

  **2. src/app/api/csp-reports/route.ts -- Remove empty string from EXPECTED_CSP_FIELDS:**

  Line 13 currently has: `'line-number', "",`
  Remove the `""` so line reads just `'line-number',` -- the empty string would match every key in Object.keys(body).some(), making the validation meaninglessly permissive.
  </action>
  <verify>pnpm lint && pnpm typecheck -- zero errors. Grep .env.example for "supabase" (case-insensitive) -- zero matches. Grep csp-reports/route.ts for empty string '""' -- zero matches.</verify>
  <done>.env.example has zero Supabase references, contains all current env vars (POSTGRES_URL, DATABASE_URL_UNPOOLED, NEON_AUTH_BASE_URL, NEON_AUTH_COOKIE_SECRET, STIRLING_PDF_URL). CSP EXPECTED_CSP_FIELDS array has no empty string.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm lint` passes with zero warnings
- [ ] `pnpm typecheck` passes with zero errors
- [ ] `pnpm test:unit` passes (no regressions)
- [ ] grep -r "process\.env\." src/ --include="*.ts" shows ONLY: env.ts (runtimeEnv), logger.ts (NODE_ENV inlining), and SKIP_ENV_VALIDATION checks
- [ ] grep -i "supabase" .env.example returns nothing
- [ ] No empty strings in EXPECTED_CSP_FIELDS array
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors or lint warnings introduced
- Every env var the app uses at runtime flows through env.ts validation (except documented exclusions)
- .env.example reflects current Neon/Drizzle stack with zero Supabase references
- CSP reports validation no longer short-circuited by empty string match
- Phase 37 complete
</success_criteria>

<output>
After completion, create `.planning/phases/37-environment-configuration-hygiene/37-01-SUMMARY.md`
</output>
