# Milestone v2.0: Audit Remediation & Feature Completion

**Status:** ✅ SHIPPED 2026-02-17
**Phases:** 37-45
**Total Plans:** 9

## Overview

Address all findings from the comprehensive 4-agent codebase audit: wire orphaned code to pages, clean up API routes, decide on authentication strategy, align with modern Next.js patterns, verify everything works, and fix all silent Tailwind class failures for visual correctness and WCAG AA compliance.

## Phases

### Phase 37: Environment & Configuration Hygiene

**Goal**: Add all bypassed env vars to env.ts validation, update .env.example from Supabase to Neon/Drizzle references, fix CSP reports empty string bug
**Depends on**: v1.1 Phase 17 complete
**Plans**: 1 plan

Plans:

- [x] 37-01: Env validation, .env.example update, CSP fix, dead auth/n8n removal

**Details:**

Audit findings addressed:
- POSTGRES_URL, NEON_AUTH_BASE_URL, NEON_AUTH_COOKIE_SECRET, STIRLING_PDF_URL bypass env.ts
- .env.example still references Supabase variables
- CSP reports route has empty string in EXPECTED_CSP_FIELDS array
- Deleted dead Neon Auth route and n8n webhook route/workflow files

---

### Phase 38: API Route Cleanup & Consolidation

**Goal**: Delete orphaned API routes (14 total), strip fake admin-auth, clean route constants, create missing paystub tool page
**Depends on**: Phase 37 (env vars validated first)
**Plans**: 1 plan

Plans:

- [x] 38-01: Delete orphaned routes, strip fake auth, clean constants/env, create paystub page

**Details:**

Audit findings addressed:
- /api/newsletter and /api/newsletter/subscribe duplication
- 14 orphaned API routes with no frontend consumers
- admin-auth.ts validateAdminAuth() always returned true (fake auth)
- 11 API routes remaining post-cleanup, all verified with consumers

---

### Phase 39: Auth Decision & Implementation

**Goal**: Decide on auth strategy — complete or remove partial Neon Auth setup
**Depends on**: Phase 38 (clean API routes before adding auth layer)
**Plans**: 1 plan (resolved in 37-38)

Plans:

- [x] 39-01: N/A — all findings resolved in Phases 37-38 (auth route deleted, admin-auth deleted, no auth needed)

**Details:**

Decision: No auth system needed for a customer-facing website. All dead auth code removed.

---

### Phase 40: Tool Calculator Pages

**Goal**: Create page.tsx wrappers for ROI Calculator, Cost Estimator, Mortgage Calculator, TTL Calculator; fix broken route constants
**Depends on**: Phase 37
**Plans**: 1 plan

Plans:

- [x] 40-01: Create 4 tool page wrappers, fix route constants and broken index links

**Details:**

Audit findings addressed:
- ROICalculatorClient.tsx, CostEstimatorClient.tsx, MortgageCalculatorClient.tsx had no page.tsx
- Calculator.tsx (TTL) was feature-complete but never imported
- TOOL_ROUTES defined PAYSTUB_GENERATOR and LOAN_CALCULATOR with no pages
- All 14 tool pages now verified with correct routes

---

### Phase 41: Location SEO Pages

**Goal**: Create /locations/[slug] dynamic pages using existing src/lib/locations.ts data (5 Texas cities)
**Depends on**: Phase 40
**Plans**: 1 plan

Plans:

- [x] 41-01: Create /locations/[slug] dynamic pages with SEO metadata and LocalBusiness schema

**Details:**

Audit findings addressed:
- src/lib/locations.ts had 5 Texas cities with full SEO data but ZERO imports anywhere
- Added generateStaticParams, generateMetadata, LocalBusiness JSON-LD

---

### Phase 42: Blog Data Strategy

**Goal**: Database-backed blog via Drizzle/Neon + structured data maximization (BlogPosting, BreadcrumbList)
**Depends on**: Phase 41
**Plans**: 1 plan

Plans:

- [x] 42-01: Database-backed blog + structured data (schema, seed, Drizzle queries, JSON-LD)

**Details:**

Audit findings addressed:
- src/lib/blog.ts had hardcoded placeholder blog posts with empty content
- Blog pages rendered but content was placeholder ("This post content is coming soon")
- Created 4 Drizzle tables: blog_authors, blog_tags, blog_posts, blog_post_tags
- Deleted 3 static blog pages (1,443 lines) — dynamic [slug] route handles all
- Added BlogPosting + BreadcrumbList JSON-LD to blog posts
- Added BreadcrumbList JSON-LD to location pages

---

### Phase 43: Next.js Architecture Alignment

**Goal**: Audit all pages for modern Next.js 15+ conventions, fix legacy patterns, add metadata to all tool pages
**Depends on**: Phase 42
**Plans**: 1 plan

Plans:

- [x] 43-01: Architecture audit, next/head removal, 9 tool pages refactored to server+client

**Details:**

Audit findings addressed:
- Removed next/head (Pages Router) from Calculator.tsx
- 9 'use client' tool pages couldn't export metadata; refactored to server+client pattern
- v1.1 Phase 15 (Performance) and Phase 16 (Architecture) items resolved
- Full codebase: 100% compliance with Next.js 15+ patterns

---

### Phase 44: Test Coverage & Final Verification

**Goal**: Add tests for v2.0 features, verify zero regressions across full suite
**Depends on**: Phase 43
**Plans**: 1 plan

Plans:

- [x] 44-01: blog.ts tests (19), locations.ts tests (12), full suite verification

**Details:**

- 31 new tests added (19 blog, 12 locations)
- 329 total passing tests, 0 TypeScript errors, 0 ESLint errors
- blog.ts: 84% function coverage, 88% line coverage
- locations.ts: 100% function + line coverage

---

### Phase 45: UI/UX Alignment & Accessibility

**Goal**: Fix navbar transparency/contrast issues, improve dark mode color tokens for WCAG AA compliance, eliminate all silent invalid Tailwind class names
**Depends on**: Phase 44
**Plans**: 1 plan

Plans:

- [x] 45-01: Navbar dark mode visibility, phantom CSS utility fix, badge removal, broken links, silent Tailwind class audit

**Details:**

Issues addressed:
- Navbar glass effect rendering: bg-background/20 → bg-background/90
- Navigation items invisible in dark mode: --color-muted-foreground-dark oklch(0.65→0.85) for WCAG AA
- text-muted (surface background color) → text-muted-foreground (text token) across 30+ files
- Eliminated all undefined Tailwind tokens: primary-hover (19 files), double-slash opacity chains, dash-opacity typos
- Replaced undefined typography utilities (text-caption, text-body, text-subheading, text-responsive-md) with Tailwind built-ins
- glass-section CVA variant remapped to existing glass-card-light (never defined)
- Mobile nav dark:text-foreground added for WCAG AA compliance
- 329 passing tests, 0 TypeScript errors, 0 ESLint errors

---

## Milestone Summary

**Key Decisions:**

- No auth system needed: this is a customer-facing website, not a SaaS app (no middleware, no session management)
- Database-backed blog via Drizzle/Neon (same API surface as static array, zero migration cost)
- Used drizzle-kit push (not migrate) for schema sync — consistent with project workflow
- Seed data via Neon MCP run_sql (not scripts) — no production credentials in codebase
- New tool pages as server components with metadata exports — better than existing 'use client' pattern
- Fix Tailwind failures at the code level (align to existing tokens) rather than growing globals.css
- Only add to globals.css what is truly structural (grid-pattern uses only --border token)

**Issues Resolved:**

- 14 orphaned API routes deleted (no consumers found)
- Fake admin-auth.ts stub removed
- All silent Tailwind class failures eliminated (undefined tokens, invalid syntax, undefined utilities)
- text-muted used as text color (references background surface) → text-muted-foreground (correct token)
- WCAG AA contrast failures in navbar and mobile nav dark mode
- Blog content no longer placeholder — database-backed via Drizzle/Neon

**Issues Deferred:**

- @react-pdf/renderer incompatible with Turbopack (pre-existing, all branches)
- database.ts at 6,286 lines (auto-generated, not actionable)
- Tools index page only lists 3 of 14 tools (future enhancement)
- Location pages beyond Texas (only 5 Texas cities currently)

**Technical Debt Incurred:**

- None significant — this milestone reduced debt substantially

---

_For current project status, see .planning/ROADMAP.md_
