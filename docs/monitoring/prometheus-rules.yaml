# Prometheus Alert Rules for Application Errors
# Deploy to your Prometheus instance in K3s
#
# These rules query the error_logs table and fire alerts
# that are then handled by Alertmanager with grouping

groups:
  - name: application-errors
    interval: 1m
    rules:
      # Alert when error rate exceeds threshold
      - alert: HighErrorRate
        expr: |
          sum(increase(app_errors_total[5m])) > 10
        for: 2m
        labels:
          severity: warning
          alertname: HighErrorRate
        annotations:
          summary: "High error rate detected"
          message: "More than 10 errors in the last 5 minutes"

      # Alert for any fatal error
      - alert: FatalError
        expr: |
          app_fatal_errors_total > 0
        for: 0m
        labels:
          severity: fatal
          alertname: FatalError
        annotations:
          summary: "Fatal error occurred"
          message: "A fatal-level error was logged"

      # Alert for new error types (first occurrence)
      - alert: NewErrorType
        expr: |
          count(count by (error_type) (app_errors_total))
          > count(count by (error_type) (app_errors_total offset 1h))
        for: 5m
        labels:
          severity: info
          alertname: NewErrorType
        annotations:
          summary: "New error type detected"
          message: "A previously unseen error type has appeared"

      # Alert for database errors
      - alert: DatabaseErrorSpike
        expr: |
          sum(increase(app_errors_total{error_type="DatabaseError"}[5m])) > 5
        for: 2m
        labels:
          severity: warning
          alertname: DatabaseErrorSpike
          error_type: DatabaseError
        annotations:
          summary: "Database error spike detected"
          message: "More than 5 database errors in the last 5 minutes"

      # Alert for validation errors (may indicate attack)
      - alert: ValidationErrorSpike
        expr: |
          sum(increase(app_errors_total{error_type="ValidationError"}[5m])) > 20
        for: 3m
        labels:
          severity: warning
          alertname: ValidationErrorSpike
          error_type: ValidationError
        annotations:
          summary: "Validation error spike detected"
          message: "More than 20 validation errors in the last 5 minutes - possible attack"

      # Alert for authentication failures
      - alert: AuthenticationFailureSpike
        expr: |
          sum(increase(app_errors_total{error_type="AuthenticationError"}[10m])) > 10
        for: 5m
        labels:
          severity: warning
          alertname: AuthenticationFailureSpike
          error_type: AuthenticationError
        annotations:
          summary: "Authentication failure spike detected"
          message: "More than 10 authentication failures in the last 10 minutes"
